<!DOCTYPE html>
<html lang="en">
<head>
<style>

#chart svg {
  height: 500px;
  width: 1200px;
}

</style>

<link rel="stylesheet" type="text/css" href="nv.d3.css">

</head>

<body>
<div>
<canvas id="canvas" width="400" height="600"></canvas>
</div>

<div id="chart">
    <svg></svg>
</div>

<meta charset="utf-8">

<script src="util.js"></script>
<script src="bot.js"></script>
<script src="victor.min.js"></script>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="nv.d3.js"></script>

<script>
var w = window.innerWidth*0.8, h = window.innerHeight*0.9, margin = 30, 
    gen_time = 10, second_count = 0;
    
var fps, saved_fps = 0, last_date, second = 0;
var canvas = document.getElementById('canvas');
canvas.setAttribute("width", w);
canvas.setAttribute("height", h);

var world = new World(w, h, margin);
var energy_history = [], energy_data = [];

var debug = true;

Init();

function GetMousePos(canvas, evt) {
  var rect = canvas.getBoundingClientRect();
  return {
    x: evt.clientX - rect.left,
    y: evt.clientY - rect.top
  };
}

function Init() {
  canvas.addEventListener('mousemove', function(evt) {
    var mouse_pos = GetMousePos(canvas, evt);
    world.MouseMove(mouse_pos);
  }, false);

  window.requestAnimationFrame(Draw);
}

function FpsLog() {
  if (!last_date) {
   last_date = Date.now();
   fps = 0;
   return;
  }
  dt = (new Date().getTime() - last_date)/1000;
  last_date = Date.now();
  fps = 1/dt;
  second += dt*1000;
  if (second > 1000) {
    saved_fps = fps;
    second = 0;
    second_count++;
    if (second_count % gen_time == 0) {
      energy_history.push({x: energy_history.length, y: world.NextGen()});
      energy_data = [];
      energy_data.push({values: energy_history, 
                        key: "Energy", color: "#FF7F0E"});
      MakeEnergyTrend();
    }
  }
  return dt;
}

function Draw() {
  var dt = FpsLog();

  var ctx = canvas.getContext('2d');

  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = "#222222";
  ctx.fillRect(0, 0, w, h);
  
  ctx = world.Draw(ctx);
  world.Update(dt);
  
  ctx.fillStyle = "#DDDDDD";
  ctx.font = "14px serif";
  ctx.fillText(saved_fps.toFixed(2), 10, 20);
 
  window.requestAnimationFrame(Draw);
}

function MakeEnergyTrend() {
  nv.addGraph(function() {
    var chart = nv.models.lineChart()
                  .margin({left: 100})
                  .useInteractiveGuideline(true)
                  .transitionDuration(350)
                  .showLegend(true)
                  .showYAxis(true)
                  .showXAxis(true)
    ;
  
    chart.xAxis
        .axisLabel('Generation');
  
    chart.yAxis
        .axisLabel('Total Energy')
        .tickFormat(d3.format('.0f'));
  
    d3.select('#chart svg')
        .datum(energy_data)
        .call(chart);
  
    nv.utils.windowResize(function() { chart.update() });
    return chart;
  });
}



</script>

</body>

</html>